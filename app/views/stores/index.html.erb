<!-- app/views/stores/index.html.erb （全文置換） -->

<div style="max-width:980px;margin:0 auto;padding:16px;">
  <h1 style="font-size:1.6rem;font-weight:700;margin-bottom:16px;">店舗一覧</h1>

  <%# 先頭メイン画像を取得（無ければ nil） %>
  <% def first_main_image_for(store)
       list = [store.try(:main_image_1), store.try(:main_image_2), store.try(:main_image_3), store.try(:main_image_4)].compact
       list.find { |att| att.respond_to?(:attached?) ? att.attached? : att.present? }
     end %>

  <% if @stores.blank? %>
    <p>公開中の店舗はありません。</p>
  <% else %>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px;">
      <% @stores.each do |store| %>
        <div style="border:1px solid #e5e5e5;border-radius:12px;overflow:hidden;background:#fff;">
          <%= link_to store_path(store), style: "display:block;text-decoration:none;color:inherit;" do %>
            <div style="width:100%;aspect-ratio:4/3;background:#f5f5f5;display:flex;align-items:center;justify-content:center;overflow:hidden;">
              <% img = first_main_image_for(store) %>
              <% if img %>
                <%= image_tag img, alt: store.name, style:"width:100%;height:100%;object-fit:cover;" %>
              <% else %>
                <%= image_tag "tempo.png", alt: "no image", style:"width:100%;height:100%;object-fit:cover;" %>
              <% end %>
            </div>

            <div style="padding:12px 12px 14px;">
              <h2 style="font-size:1.05rem;font-weight:700;margin:0 0 6px;"><%= store.name %></h2>

              <div style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 8px;">
                <span style="font-size:.82rem;border:1px solid #ddd;border-radius:999px;padding:2px 8px;background:#fafafa;"><%= store.store_type.presence || "未設定" %></span>
                <span style="font-size:.82rem;border:1px solid #ddd;border-radius:999px;padding:2px 8px;background:#fafafa;"><%= store.smoking_allowed.presence || "未設定" %></span>
                <span style="font-size:.82rem;border:1px solid #ddd;border-radius:999px;padding:2px 8px;background:#fafafa;">
                  予算:
                  <%= (
                        {0=>"不明",1000=>"1000円",2000=>"2000円",3000=>"3000円"}[store.budget.to_i] ||
                        (store.budget.present? ? number_to_currency(store.budget, unit:"¥", precision:0) : "未設定")
                      ) %>
                </span>
              </div>

              <p style="font-size:.9rem;color:#333;margin:0 0 4px;">
                <%= [store.prefecture, store.city, store.address_detail].compact.reject(&:blank?).join(' ') %>
              </p>
              <p style="font-size:.88rem;color:#666;margin:0;">
                <%= truncate(store.description.to_s, length: 60) %>
              </p>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
