<div class="store-show-container">

<!-- ãƒ¡ã‚¤ãƒ³ç”»åƒã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆActiveStorageç‰ˆã«æˆ»ã™ï¼‰ -->
<div class="main-image-section">
  <% slots = [@store.main_image_1, @store.main_image_2, @store.main_image_3, @store.main_image_4] %>
  <% first = slots.find { |s| s.respond_to?(:attached?) && s.attached? } %>
  <div class="main-image-container">
    <% if first %>
      <%= image_tag url_for(first), alt: "ãƒ¡ã‚¤ãƒ³ç”»åƒ01", class: "main-image" %>
    <% else %>
      <%= image_tag "tempo.png", alt: "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒ", class: "main-image" %>
    <% end %>
  </div>
</div>


  <!-- ã‚µãƒ–ç”»åƒã¸ã®ã‚«ãƒ†ã‚´ãƒªãƒªãƒ³ã‚¯ -->
  <div class="sub-image-categories">
    <%= link_to "å†…è¦³ã‚’è¦‹ã‚‹ï¼ˆ#{Array(@store.interior_images).count}æšï¼‰", interior_images_store_path(@store), target: "_blank" %>
    <%= link_to "å¤–è¦³ã‚’è¦‹ã‚‹ï¼ˆ#{Array(@store.exterior_images).count}æšï¼‰", exterior_images_store_path(@store), target: "_blank" %>
    <%= link_to "æ–™ç†ã‚’è¦‹ã‚‹ï¼ˆ#{Array(@store.food_images).count}æšï¼‰", food_images_store_path(@store), target: "_blank" %>
    <%= link_to "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹ï¼ˆ#{Array(@store.menu_images).count}æšï¼‰", menu_images_store_path(@store), target: "_blank" %>
  </div>

  <!-- åº—èˆ—åŸºæœ¬æƒ…å ± -->
  <div class="store-header">
    <h1><%= @store.name %></h1>

    <div class="icon-row">
      <span class="icon">[<%= @store.store_type %>]</span>
      <span class="icon">[<%= @store.smoking_allowed %>]</span>

      <% if logged_in? %>
        <%= button_to "æ¥åº—ãƒœã‚¿ãƒ³", visit_store_path(store_id: @store.id), method: :post, class: "visit-btn" %>
        <% if current_user.favorites.exists?(store: @store) %>
          <%= button_to 'ãŠæ°—ã«å…¥ã‚Šè§£é™¤', favorite_path(id: @store.id), method: :delete, class: 'unfavorite-btn' %>
        <% else %>
          <%= button_to 'ãŠæ°—ã«å…¥ã‚Šç™»éŒ²', favorites_path(id: @store.id), method: :post, class: 'favorite-btn' %>
        <% end %>
      <% end %>
    </div>

    <p class="address"><%= [@store.postal_code, @store.prefecture, @store.city, @store.address_detail].join(' ') %></p>
    <p class="description"><%= simple_format(@store.description) %></p>
  </div>

  <!-- åº—èˆ—è©³ç´°æƒ…å ± -->
  <div class="store-details-grid">
    <div class="store-info-box">
      <h2>åº—èˆ—æƒ…å ±</h2>
  
      <p><strong>å–¶æ¥­æ™‚é–“ï¼š</strong></p>
      <% txt = @store.try(:hours_text).presence || Post.find_by(id: @store.post_id)&.hours_text %>
      <% if txt.present? %>
        <div style="white-space:pre-line;"><%= h(txt) %></div>
      <% else %>
        <span style="color:#b50000;">æœªå…¥åŠ›</span>
      <% end %>
      
  
  
    <!-- ===== æ—§ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ›œæ—¥ãƒ†ãƒ¼ãƒ–ãƒ«å„ªå…ˆï¼‰å®Œå…¨ä¿ç®¡ï¼šå®Ÿè¡Œä¸å¯ ===== -->
    <template id="store-hours-legacy-preserved" style="display:none;"><%= raw(ERB::Util.html_escape(<<~'ERB')) %>
    <!-- åº—èˆ—æƒ…å ±ï¼ˆã“ã“ã‚’ä¸¸ã”ã¨ç½®æ›ï¼‰ -->
    <div class="store-info-box">
      <h2>åº—èˆ—æƒ…å ±</h2>
    
      <%# 1) opening_hours_json ãŒã‚ã‚Œã°æ›œæ—¥åˆ¥ã‚’è¡¨ç¤º / ãªã‘ã‚Œã°å¾“æ¥è¡¨ç¤º %>
      <% hours = @store.opening_hours_json.presence %>
      <% hours = JSON.parse(hours) if hours.is_a?(String) %>
      <% days = %w[æœˆ ç« æ°´ æœ¨ é‡‘ åœŸ æ—¥ ç¥] %>
    
      <% if hours.present? %>
        <p><strong>å®šä¼‘æ—¥ï¼š</strong>
          <% if @store.irregular_holiday %>ä¸å®šä¼‘<% elsif @store.holidays.present? %><%= @store.holidays %><% else %>æœªè¨­å®š<% end %>
        </p>
    
        <div class="hours-table-wrapper" style="overflow-x:auto">
          <table class="hours-table" style="width:100%;border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left;padding:4px 6px;">æ›œæ—¥</th>
                <th style="text-align:left;padding:4px 6px;">å–¶æ¥­æ™‚é–“â‘ </th>
                <th style="text-align:left;padding:4px 6px;">å–¶æ¥­æ™‚é–“â‘¡</th>
                <th style="text-align:left;padding:4px 6px;">ä¼‘</th>
              </tr>
            </thead>
            <tbody>
              <% days.each do |d| %>
                <% row =
                     if hours.is_a?(Array)
                       hours.find{|h| h["day"].to_s==d } || {}
                     else
                       {
                         "open1"=>hours["#{d}_open1"], "close1"=>hours["#{d}_close1"],
                         "open2"=>hours["#{d}_open2"], "close2"=>hours["#{d}_close2"],
                         "holiday"=>(hours["#{d}_holiday"].to_s=="1")
                       }
                     end %>
                <% fmt = ->(v){ s=v.to_s.gsub(/\D/,'')[0,4]; s.present? ? "#{s.rjust(4,'0')[0,2]}:#{s.rjust(4,'0')[2,2]}" : "" } %>
                <tr>
                  <td style="padding:4px 6px;"><%= d %></td>
                  <td style="padding:4px 6px;"><%= [fmt.call(row["open1"]), fmt.call(row["close1"])].reject(&:blank?).join("ã€œ") %></td>
                  <td style="padding:4px 6px;"><%= [fmt.call(row["open2"]), fmt.call(row["close2"])].reject(&:blank?).join("ã€œ") %></td>
                  <td style="padding:4px 6px;"><%= row["holiday"] ? "âœ“" : "" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p><strong>å–¶æ¥­æ™‚é–“ï¼š</strong>
          <% if @store.opening_time.present? && @store.closing_time.present? %>
            <%= @store.opening_time %>ã€œ<%= @store.closing_time %>
          <% else %>
            <span style="color:#b50000;">æœªå…¥åŠ›</span>
          <% end %>
        </p>
        <p><strong>å®šä¼‘æ—¥ï¼š</strong>
          <% if @store.irregular_holiday %>ä¸å®šä¼‘<% elsif @store.holidays.present? %><%= @store.holidays %><% else %>æœªè¨­å®š<% end %>
        </p>
      <% end %>
    </div>
    ERB
    ) %></template>
  
  </div>
  
  
  

  <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="comments-section">
    <h3 class="comments-title">ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>
  
    <button
      id="show-comment-form"
      class="comment-write-btn"
      data-can-comment="<%= current_user ? 'true' : 'false' %>">
      ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã
    </button>
  
    <%# æ—§æ³¨è¨˜ï¼šæ¥åº—æ¸ˆã¿é™å®šï¼ˆä¿ç®¡ï¼‰ %>
    <%# <span class="comment-note">ï¼ˆä¼šå“¡æ§˜ / æ¥åº—æ¸ˆã¿ã®æ–¹ã®ã¿æŠ•ç¨¿ã§ãã¾ã™ï¼‰</span> %>
    <span class="comment-note">ï¼ˆä¼šå“¡æ§˜ã®ã¿æŠ•ç¨¿ã§ãã¾ã™ï¼‰</span>
  
    <div id="comment-form" class="comment-form hidden">
      <%# æ—§æ¡ä»¶ï¼š@can_commentï¼ˆæ¥åº—å¿…é ˆï¼‰ã‚’ä¿ç®¡ %>
      <%# if @can_comment %>
      <% if current_user %>
        <%= form_with(model: [@store, Comment.new], local: true) do |f| %>
          <div class="form-group">
            <%= f.label :title, "ã‚¿ã‚¤ãƒˆãƒ«" %>
            <%= f.text_field :title, placeholder: "ä¾‹ï¼šè½ã¡ç€ã„ãŸç«‹ã¡é£²ã¿ã§ã—ãŸ" %>
          </div>
          <div class="form-group">
            <%= f.label :body, "æœ¬æ–‡" %>
            <%= f.text_area :body, placeholder: "ãŠåº—ã®é›°å›²æ°—ã‚„æ„Ÿæƒ³ã‚’æ›¸ã„ã¦ãã ã•ã„â€¦", rows: 4 %>
          </div>
          <%= f.submit "æŠ•ç¨¿ã™ã‚‹", class: "submit-btn" %>
        <% end %>
      <% end %>
      <%# end %>
    </div>
  
    <hr>
  
    <div id="comments-root">
      <% @comments.each do |comment| %>
        <div class="comment-card">
          <div class="comment-content">
            <h4 class="comment-title"><%= comment.title.presence || "ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰" %></h4>
            <p class="comment-body-text"><%= simple_format(comment.body) %></p>
          </div>
  
          <div class="comment-meta-row">
            <div class="meta-left">
              <%= link_to user_path(comment.user), class: "user-icon-link" do %>
                <%= image_tag(
                      comment.user.icon.attached? ? url_for(comment.user.icon) : asset_path("icon.png"),
                      class: "user-icon", alt: "user icon") %>
              <% end %>
              <div class="user-info-inline">
                <%= link_to comment.user.username, user_path(comment.user), class: "user-name" %>
                <span class="date"><%= comment.created_at.strftime('%Y-%m-%d %H:%M') %></span>
              </div>
            </div>
  
            <div class="vote-section"
                 data-store-id="<%= @store.id %>"
                 data-comment-id="<%= comment.id %>">
              <button
                class="score good-btn
                  <%= 'active' if @user_votes[comment.id] == 'good' %>
                  <%= 'inactive' if @user_votes[comment.id] != 'good' %>"
                data-type="good"
                data-id="<%= comment.id %>">
                ğŸ‘ GOOD: <span class="good-count"><%= comment.good_count %></span>
              </button>
  
              <button
                class="score bad-btn
                  <%= 'active' if @user_votes[comment.id] == 'bad' %>
                  <%= 'inactive' if @user_votes[comment.id] != 'bad' %>"
                data-type="bad"
                data-id="<%= comment.id %>">
                ğŸ‘ BAD: <span class="bad-count"><%= comment.bad_count %></span>
              </button>
  
              <div id="flash-banner"
                   style="position: fixed;
                          top: 70px;
                          left: 50%;
                          transform: translateX(-50%);
                          z-index: 9999;
                          display: none;
                          background: #333;
                          color: #fff;
                          padding: 12px 24px;
                          border-radius: 8px;
                          font-weight: bold;
                          box-shadow: 0 3px 8px rgba(0,0,0,0.3);">
              </div>
  
              <%= link_to "ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å ±å‘Šã™ã‚‹", new_report_path(comment_id: comment.id), class: "report-link" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  
    <% if @store.comments.count > 10 %>
      <%= link_to "ã‚‚ã£ã¨è¦‹ã‚‹", store_comments_path(@store), class: "more-comments" %>
    <% end %>
  </div>
  
  <!-- ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ é–‹é–‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
  (function () {
    if (window.__commentToggleInit) return;
    window.__commentToggleInit = true;
  
    function initCommentToggle() {
      var btn  = document.getElementById('show-comment-form');
      var form = document.getElementById('comment-form');
      if (!btn || !form) return;
  
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        var can = (btn.dataset.canComment === 'true');
        if (!can) {
          alert('ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
          return;
        }
        form.classList.toggle('hidden');
      }, { passive: false });
    }
  
    document.addEventListener('turbolinks:load', initCommentToggle);
    document.addEventListener('turbo:load', initCommentToggle);
    document.addEventListener('DOMContentLoaded', initCommentToggle);
  })();
  </script>
  
  
  <div class="edit-request-link">
    <%= link_to "åº—èˆ—æƒ…å ±ã®ä¿®æ­£ã‚’ç”³è«‹ã™ã‚‹", new_post_path(store_id: @store.id), class: "edit-link" %>
  </div>
</div>

