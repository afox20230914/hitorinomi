<% if @user.errors.any? %>
  <div id="error_explanation">
    <h2><%= @user.errors.count %>件のエラーがあります:</h2>
    <ul>
      <% @user.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<div class="form-container">
  <h2>登録情報の編集</h2>

  <%= form_with(model: @user, local: true, html: { multipart: true }, class: "user-form") do |f| %>

    <!-- 名前 -->
    <div class="field-row">
      <div class="field">
        <%= f.label :last_name, "名字（全角）", class: "field-label" %>
        <%= f.text_field :last_name, class: "input-field" %>
      </div>
      <div class="field">
        <%= f.label :first_name, "名前（全角）", class: "field-label" %>
        <%= f.text_field :first_name, class: "input-field" %>
      </div>
    </div>

    <!-- メール -->
    <div class="field">
      <%= f.label :email, "メールアドレス", class: "field-label" %>
      <%= f.email_field :email, class: "input-field" %>
    </div>

    <!-- 電話番号 -->
    <div class="field">
      <%= f.label :phone_number, "電話番号（ハイフンなし）", class: "field-label" %>
      <%= f.telephone_field :phone_number, class: "input-field" %>
    </div>

    <!-- 生年月日（編集不可） -->
    <div class="field form-date">
      <%= f.label :birth_date, "生年月日（変更不可）", class: "field-label" %><br>
      <%= f.date_select :birth_date, start_year: Date.today.year - 100, end_year: Date.today.year,
                        use_month_numbers: true, disabled: true %>
    </div>
    
    <!-- ユーザー名（編集不可） -->
    <div class="field">
      <%= f.label :username, "ユーザー名（変更不可）", class: "field-label" %>
      <%= f.text_field :username, class: "input-field", readonly: true %>
    </div>

    <!-- プロフィール画像 -->
    <div class="field image-upload">
      <%= f.label :icon, "プロフィール画像", class: "field-label" %><br>
      <%= f.file_field :icon, accept: 'image/*', onchange: "previewIcon(event)" %>
      <%= image_tag(@user.icon.attached? ? url_for(@user.icon) : 'icon.png', id: "icon-preview", class: "profile-preview") %>
    </div>
    
    <!-- プロフィール文 -->
    <div class="field">
      <%= f.label :profile, "プロフィール（任意）", class: "field-label" %>
      <%= f.text_area :profile, class: "input-field profile-text" %>
    </div>

    <!-- パスワード -->
    <div class="field">
      <%= f.label :password, "パスワード（8文字以上）", class: "field-label" %>
      <%= f.password_field :password, placeholder: "変更しない場合は空欄のまま", class: "input-field" %>
    </div>

    <div class="field">
      <%= f.label :password_confirmation, "確認用パスワード", class: "field-label" %>
      <%= f.password_field :password_confirmation, class: "input-field" %>
    </div>

    <!-- 送信ボタン -->
    <%= f.submit "変更を保存する", class: "submit-btn" %>
  <% end %>
</div>

<!-- プレビューJS -->
<script>
  function previewIcon(event) {
    const input = event.target;
    const preview = document.getElementById('icon-preview');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>
